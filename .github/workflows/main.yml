name: Krypton Release Builder

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.5.0)'
        required: true
        type: string
      create_release:
        description: 'Create GitHub Release'
        required: true
        type: boolean
        default: true

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          choco install mingw -y
          
      - name: Build Windows 64-bit
        run: |
          cd depends
          make HOST=x86_64-w64-mingw32 -j$(nproc)
          cd ..
          ./autogen.sh
          CONFIG_SITE=$PWD/depends/x86_64-w64-mingw32/share/config.site ./configure --prefix=/
          make -j$(nproc)
        shell: bash

      - name: Package Windows binaries
        run: |
          mkdir -p krypton-${{ inputs.version }}-win64
          cp src/kryptond.exe krypton-${{ inputs.version }}-win64/
          cp src/krypton-cli.exe krypton-${{ inputs.version }}-win64/
          cp src/krypton-tx.exe krypton-${{ inputs.version }}-win64/
          cp src/qt/krypton-qt.exe krypton-${{ inputs.version }}-win64/
          7z a krypton-${{ inputs.version }}-win64.zip krypton-${{ inputs.version }}-win64
        shell: bash

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: krypton-${{ inputs.version }}-win64.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libtool autotools-dev automake \
            pkg-config bsdmainutils curl git libboost-all-dev libssl-dev \
            libevent-dev libdb++-dev libminiupnpc-dev libzmq3-dev \
            libqt5gui5 libqt5core5a libqt5dbus5 qttools5-dev qttools5-dev-tools

      - name: Build Linux 64-bit
        run: |
          ./autogen.sh
          ./configure --disable-tests --disable-bench
          make -j$(nproc)

      - name: Package Linux binaries
        run: |
          mkdir -p krypton-${{ inputs.version }}-x86_64-linux-gnu
          cp src/kryptond krypton-${{ inputs.version }}-x86_64-linux-gnu/
          cp src/krypton-cli krypton-${{ inputs.version }}-x86_64-linux-gnu/
          cp src/krypton-tx krypton-${{ inputs.version }}-x86_64-linux-gnu/
          cp src/qt/krypton-qt krypton-${{ inputs.version }}-x86_64-linux-gnu/
          tar -czf krypton-${{ inputs.version }}-x86_64-linux-gnu.tar.gz krypton-${{ inputs.version }}-x86_64-linux-gnu

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: krypton-${{ inputs.version }}-x86_64-linux-gnu.tar.gz

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          brew install automake libtool boost miniupnpc openssl pkg-config \
            berkeley-db@4 qt@5 zmq libevent

      - name: Build macOS
        run: |
          ./autogen.sh
          ./configure --disable-tests --disable-bench
          make -j$(sysctl -n hw.ncpu)

      - name: Create DMG (macOS installer)
        run: |
          mkdir -p dist
          # Créer le .app bundle
          mkdir -p "Krypton-Qt.app/Contents/MacOS"
          cp src/qt/krypton-qt "Krypton-Qt.app/Contents/MacOS/"
          
          # Créer le DMG
          hdiutil create -volname "Krypton ${{ inputs.version }}" \
            -srcfolder "Krypton-Qt.app" \
            -ov -format UDZO \
            krypton-${{ inputs.version }}-x86_64-apple-darwin-setup.dmg

      - name: Package macOS binaries (tar.gz)
        run: |
          mkdir -p krypton-${{ inputs.version }}-x86_64-apple-darwin
          cp src/kryptond krypton-${{ inputs.version }}-x86_64-apple-darwin/
          cp src/krypton-cli krypton-${{ inputs.version }}-x86_64-apple-darwin/
          cp src/krypton-tx krypton-${{ inputs.version }}-x86_64-apple-darwin/
          tar -czf krypton-${{ inputs.version }}-x86_64-apple-darwin.tar.gz \
            krypton-${{ inputs.version }}-x86_64-apple-darwin

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: |
            krypton-${{ inputs.version }}-x86_64-apple-darwin-setup.dmg
            krypton-${{ inputs.version }}-x86_64-apple-darwin.tar.gz

  create-release:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: ${{ inputs.create_release }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Display structure
        run: ls -R

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.version }}
          name: Krypton v${{ inputs.version }}
          draft: false
          prerelease: false
          body: |
            ## Krypton v${{ inputs.version }}
            
            ### Downloads
            
            **Windows:**
            - `krypton-${{ inputs.version }}-win64.zip` - Portable binaries
            
            **Linux:**
            - `krypton-${{ inputs.version }}-x86_64-linux-gnu.tar.gz`
            
            **macOS:**
            - `krypton-${{ inputs.version }}-x86_64-apple-darwin-setup.dmg` - macOS installer
            - `krypton-${{ inputs.version }}-x86_64-apple-darwin.tar.gz` - macOS binaries
            
            ### Changes
            - Updated to version ${{ inputs.version }}
            - [Add your changelog here]
            
            ### Installation
            
            **Windows:** Extract the ZIP file and run krypton-qt.exe
            **Linux:** Extract and run: `./krypton-qt`
            **macOS:** Mount the DMG and drag to Applications folder
          files: |
            krypton-${{ inputs.version }}-win64.zip
            krypton-${{ inputs.version }}-x86_64-linux-gnu.tar.gz
            krypton-${{ inputs.version }}-x86_64-apple-darwin-setup.dmg
            krypton-${{ inputs.version }}-x86_64-apple-darwin.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
